/*!
 * maptalks.imagelayer v0.4.1
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@>=0.32.0 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):function(t,e){for(var n=Object.getOwnPropertyNames(e),r=0;r<n.length;r++){var a=n[r],o=Object.getOwnPropertyDescriptor(e,a);o&&o.configurable&&void 0===t[a]&&Object.defineProperty(t,a,o)}}(t,e))}var o={renderer:e.Browser.webgl?"gl":"canvas",crossOrigin:null},i=function(t){function o(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,o);var i=r(this,t.call(this,e,a));return i._options=a,i._images=a.images,i._extent=a.extent,i}return a(o,t),o.prototype.onLoad=function(){var t=this;if(this.imgData&&this.imgData.length>0)return!0;this.imgData=[];for(var e=this._images.length,n=0;n<e;n++)!function(n){var r=new Image;r.src=t._images[n].url,r.crossOrigin=t._options.crossOrigin,r.onload=function(){t.imgData.push({img:r,extent:t._images[n].extent}),n===e-1&&t.load()}}(n);return!1},o.prototype._isInExtent=function(t){return!!this.getMap().getExtent().intersection(new e.Extent(t))},o}(e.Layer);i.mergeOptions(o);var s=function(t){function o(){return n(this,o),r(this,t.apply(this,arguments))}return a(o,t),o.prototype.onAdd=function(){},o.prototype.needToRedraw=function(){var e=this.layer.getMap();return!e.isZooming()&&(!e.isMoving()&&t.prototype.needToRedraw.call(this))},o.prototype.draw=function(){this.prepareCanvas(),this._drawImages()},o.prototype._drawImages=function(){if(this.layer.imgData&&this.layer.imgData.length>0){for(var t=0;t<this.layer.imgData.length;t++)this._drawImage(this.layer.imgData[t]);this.completeRender()}},o.prototype._drawImage=function(t){var n=new e.Extent(t.extent);if(this.layer._isInExtent(n)){var r=this._buildDrawParams(n);this.context.drawImage(t.img,r.x,r.y,r.width,r.height)}},o.prototype._buildDrawParams=function(t){var n=new e.Coordinate(t.xmin,t.ymax),r=new e.Coordinate(t.xmax,t.ymin),a=this.layer.getMap().coordinateToContainerPoint(n),o=this.layer.getMap().coordinateToContainerPoint(r),i=o.x-a.x,s=o.y-a.y;return{x:a.x,y:a.y,width:i,height:s}},o.prototype.drawOnInteracting=function(){this.draw()},o.prototype.hitDetect=function(){return!1},o.prototype.onZoomEnd=function(e){t.prototype.onZoomEnd.call(this,e)},o.prototype.onMoveEnd=function(e){t.prototype.onMoveEnd.call(this,e)},o.prototype.onDragRotateEnd=function(e){t.prototype.onDragRotateEnd.call(this,e)},o}(e.renderer.CanvasRenderer);i.registerRenderer("canvas",s),i.registerRenderer("gl",function(t){function o(){return n(this,o),r(this,t.apply(this,arguments))}return a(o,t),o.prototype.isDrawable=function(){return!0},o.prototype.needToRedraw=function(){var e=this.getMap();return!!e.isZooming()||(!!e.isMoving()||(!!e.isRotating()||t.prototype.needToRedraw.call(this)))},o.prototype.draw=function(){this.prepareCanvas(),this._drawImages()},o.prototype._drawImages=function(){if(this.layer.imgData&&this.layer.imgData.length>0){for(var t=0;t<this.layer.imgData.length;t++)this._drawImage(this.layer.imgData[t]);this.completeRender()}},o.prototype._drawImage=function(t){var n=this.getMap().getGLZoom(),r=new e.Extent(t.extent);if(this.layer._isInExtent(r)){var a=new e.Coordinate(r.xmin,r.ymax),o=new e.Coordinate(r.xmax,r.ymin),i=this.layer.getMap()._prjToPoint(a,n),s=this.layer.getMap()._prjToPoint(o,n),p=s.x-i.x,c=s.y-i.y;this.drawGLImage(t.img,i.x,i.y,p,c,1)}},o.prototype.drawOnInteracting=function(){this.draw()},o.prototype.onCanvasCreate=function(){this.prepareGLCanvas()},o.prototype.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},o.prototype.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},o.prototype.getCanvasImage=function(){if(this.glCanvas&&this.isCanvasUpdated()){var n=this.context;e.Browser.retina&&(n.save(),n.scale(.5,.5)),n.drawImage(this.glCanvas,0,0),e.Browser.retina&&n.restore()}return t.prototype.getCanvasImage.call(this)},o.prototype.onRemove=function(){this.removeGLCanvas()},o}(e.renderer.ImageGLRenderable(s))),t.ImageLayer=i,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.imagelayer v0.4.1, requires maptalks@>=0.32.0.")});